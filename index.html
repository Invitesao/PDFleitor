<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Convites Digitais Seguros - Supabase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
        }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        
        /* Prote√ß√£o contra print */
        @media print {
            body * {
                visibility: hidden !important;
            }
            body::before {
                content: "üö´ IMPRESS√ÉO N√ÉO AUTORIZADA - Este documento n√£o pode ser impresso por motivos de seguran√ßa." !important;
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                font-size: 24px !important;
                color: red !important;
                visibility: visible !important;
                z-index: 9999 !important;
            }
        }
        
        .protection-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            color: #fff;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            font-size: 24px;
            text-align: center;
        }
        
        /* Desabilitar arrastar imagens */
        img {
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            user-drag: none;
            pointer-events: none;
        }

        /* Prote√ß√µes aplicadas apenas quando necess√°rio */
        .protected-content {
            position: relative;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Overlay de Prote√ß√£o -->
    <div id="protectionOverlay" class="protection-overlay">
        <div>
            <div style="font-size: 48px; margin-bottom: 20px;">üö´</div>
            <div>A√á√ÉO N√ÉO PERMITIDA</div>
            <div style="font-size: 16px; margin-top: 10px;">Este conte√∫do est√° protegido</div>
        </div>
    </div>
    
    <div class="container mx-auto px-4 py-8 protected-content">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">Sistema de Convites Seguros</h1>
            <p class="text-white/80">Integrado com Supabase - Prote√ß√£o Total Online e Offline</p>
        </div>

        <!-- Login Screen -->
        <div id="loginScreen" class="bg-white rounded-2xl card-shadow p-8 mb-8">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">üîê</div>
                <h2 class="text-2xl font-semibold text-gray-800 mb-2">Acesso Administrativo</h2>
                <p class="text-gray-600">Fa√ßa login para acessar o painel de controle</p>
            </div>
            
            <div class="max-w-md mx-auto">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Usu√°rio</label>
                        <input type="text" id="adminUsername" placeholder="Digite o usu√°rio" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Senha</label>
                        <input type="password" id="adminPassword" placeholder="Digite a senha" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <button onclick="authenticateAdmin()" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-colors">
                        Fazer Login
                    </button>
                </div>
                
                <div id="loginError" class="text-red-600 text-sm mt-4 text-center hidden"></div>
                
                <div class="mt-6 text-center">
                    <p class="text-xs text-gray-500">
                        üîí Acesso restrito apenas para administradores autorizados
                    </p>
                </div>
            </div>
        </div>

        <!-- Admin Panel (Hidden by default) -->
        <div id="adminPanel" class="bg-white rounded-2xl card-shadow p-8 mb-8 hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-800">Painel Administrativo</h2>
                <button onclick="logoutAdmin()" 
                        class="bg-red-600 hover:bg-red-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition-colors">
                    Sair
                </button>
            </div>
            

            
            <!-- Supabase Status -->
            <div class="bg-green-50 rounded-lg p-4 mb-6">
                <div class="flex items-center gap-3">
                    <div class="text-green-600 text-2xl">‚úÖ</div>
                    <div>
                        <h3 class="text-lg font-medium text-green-800">Supabase Conectado</h3>
                        <p class="text-sm text-green-700">Sistema pronto para criar convites seguros</p>
                    </div>
                </div>
            </div>

            <!-- AVISO DE SEGURAN√áA ATUALIZADO -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <div class="flex items-center gap-3">
                    <div class="text-blue-600 text-2xl">üõ°Ô∏è</div>
                    <div>
                        <h3 class="text-lg font-medium text-blue-800">VISUALIZADOR INTEGRADO ATIVO</h3>
                        <p class="text-sm text-blue-700">PDFs abrem dentro do sistema ‚Ä¢ Imposs√≠vel copiar URLs ‚Ä¢ Links interativos funcionais ‚Ä¢ Prote√ß√£o anti-screenshot</p>
                    </div>
                </div>
            </div>

            <!-- Method Selection -->
            <div class="mb-6">
                <h3 class="text-lg font-medium text-gray-700 mb-4">üéØ M√©todo de Gera√ß√£o</h3>
                <div class="grid md:grid-cols-3 gap-4">
                    <button onclick="selectMethod('bulk')" id="bulkMethod" 
                            class="method-btn p-4 border-2 border-gray-300 rounded-lg text-center hover:border-blue-500 transition-colors">
                        <div class="text-2xl mb-2">üìÑ</div>
                        <h4 class="font-medium text-gray-800">M√©todo 1: Bulk</h4>
                        <p class="text-xs text-gray-600">1 ou v√°rios PDFs + Lista</p>
                    </button>
                    <button onclick="selectMethod('multiple')" id="multipleMethod" 
                            class="method-btn p-4 border-2 border-gray-300 rounded-lg text-center hover:border-blue-500 transition-colors">
                        <div class="text-2xl mb-2">üìö</div>
                        <h4 class="font-medium text-gray-800">M√©todo 2: M√∫ltiplos PDFs</h4>
                        <p class="text-xs text-gray-600">V√°rios PDFs individuais</p>
                    </button>
                    <button onclick="selectMethod('links')" id="linksMethod" 
                            class="method-btn p-4 border-2 border-gray-300 rounded-lg text-center hover:border-blue-500 transition-colors">
                        <div class="text-2xl mb-2">üîó</div>
                        <h4 class="font-medium text-gray-800">M√©todo 3: Links Avulsos</h4>
                        <p class="text-xs text-gray-600">S√≥ gerar links √∫nicos</p>
                    </button>
                </div>
            </div>

            <!-- Method 1: Bulk Upload -->
            <div id="bulkUpload" class="space-y-6 hidden">
                <h3 class="text-lg font-medium text-gray-700">üìÑ M√©todo 1: Upload Bulk</h3>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">Nome dos Noivos</label>
                            <input type="text" id="coupleNames1" placeholder="Jo√£o & Maria" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">Data do Evento</label>
                            <input type="date" id="eventDate1" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <!-- PDF Upload Options -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <label class="block text-sm font-medium text-gray-600 mb-3">Tipo de PDF:</label>
                            <div class="space-y-3">
                                <label class="flex items-start">
                                    <input type="radio" name="pdfType1" value="single" checked class="mr-3 mt-1" onchange="togglePdfUpload()">
                                    <div>
                                        <span class="text-sm font-medium">üìÑ 1 PDF para todos</span>
                                        <p class="text-xs text-gray-500">Mesmo convite para todos os convidados (mais comum)</p>
                                    </div>
                                </label>
                                <label class="flex items-start">
                                    <input type="radio" name="pdfType1" value="multiple" class="mr-3 mt-1" onchange="togglePdfUpload()">
                                    <div>
                                        <span class="text-sm font-medium">üìö V√°rios PDFs individuais</span>
                                        <p class="text-xs text-gray-500">Cada convidado tem seu PDF personalizado (raro)</p>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Single PDF Upload -->
                        <div id="singlePdfUpload1">
                            <label class="block text-sm font-medium text-gray-600 mb-2">Upload do Convite (1 PDF)</label>
                            <input type="file" id="singlePdfFile1" accept=".pdf" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">Este PDF ser√° usado para todos os convidados</p>
                        </div>

                        <!-- Multiple PDFs Upload -->
                        <div id="multiplePdfUpload1" class="hidden">
                            <label class="block text-sm font-medium text-gray-600 mb-2">Upload dos PDFs Individuais</label>
                            <input type="file" id="multiplePdfFiles1" accept=".pdf" multiple 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">Selecione v√°rios PDFs (um para cada convidado)</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">Lista de Convidados</label>
                            <div class="flex gap-2">
                                <input type="file" id="guestListFile1" accept=".txt" 
                                       class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <span class="text-gray-400 self-center">ou</span>
                                <button type="button" onclick="toggleGuestInput()" 
                                        class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                                    Digitar
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Arquivo TXT com um nome por linha</p>
                            
                            <!-- Manual guest input -->
                            <div id="manualGuestInput1" class="hidden mt-3">
                                <textarea id="guestNamesManual1" placeholder="Maria Silva&#10;Jo√£o Santos&#10;Ana Costa" 
                                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent h-32"></textarea>
                                <p class="text-xs text-gray-500 mt-1">Um nome por linha</p>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <label class="flex items-center">
                                <input type="radio" name="validationType1" value="device" class="mr-2">
                                <span class="text-sm">Valida√ß√£o por Dispositivo</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="validationType1" value="name" checked class="mr-2">
                                <span class="text-sm">Valida√ß√£o por Nome</span>
                            </label>
                        </div>
                        <button onclick="processBulkInvitation()" 
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-colors">
                            Processar Bulk
                        </button>
                    </div>
                    <div class="bg-blue-50 p-6 rounded-lg">
                        <h4 class="font-medium text-blue-800 mb-2">üí° M√©todo 1: Bulk</h4>
                        <div id="bulkExplanation">
                            <ul class="text-sm text-blue-700 space-y-1">
                                <li>‚Ä¢ <strong>1 PDF:</strong> Mesmo convite para todos</li>
                                <li>‚Ä¢ <strong>V√°rios PDFs:</strong> Cada um personalizado</li>
                                <li>‚Ä¢ Lista de convidados (TXT ou digitada)</li>
                                <li>‚Ä¢ Links √∫nicos para cada pessoa</li>
                                <li>‚Ä¢ Cada um precisa digitar seu nome</li>
                                <li>‚Ä¢ Tudo salvo no Supabase com seguran√ßa</li>
                                <li>‚Ä¢ <strong>üõ°Ô∏è VISUALIZADOR INTEGRADO - Imposs√≠vel compartilhar</strong></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Method 2: Multiple PDFs -->
            <div id="multipleUpload" class="space-y-6 hidden">
                <h3 class="text-lg font-medium text-gray-700">üìö M√©todo 2: Upload M√∫ltiplos PDFs</h3>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">Nome dos Noivos</label>
                            <input type="text" id="coupleNames2" placeholder="Jo√£o & Maria" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">Data do Evento</label>
                            <input type="date" id="eventDate2" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">Upload M√∫ltiplos PDFs</label>
                            <input type="file" id="multiplePdfFiles" accept=".pdf" multiple 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">Nomes dos Convidados</label>
                            <textarea id="guestNames2" placeholder="Maria Silva&#10;Jo√£o Santos&#10;Ana Costa" 
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent h-32"></textarea>
                            <p class="text-xs text-gray-500 mt-1">Um nome por linha (mesmo n√∫mero de PDFs)</p>
                        </div>
                        <button onclick="processMultiplePDFs()" 
                                class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg transition-colors">
                            Processar M√∫ltiplos PDFs
                        </button>
                    </div>
                    <div class="bg-green-50 p-6 rounded-lg">
                        <h4 class="font-medium text-green-800 mb-2">üí° M√©todo 2: M√∫ltiplos PDFs</h4>
                        <ul class="text-sm text-green-700 space-y-1">
                            <li>‚Ä¢ Cada PDF gera seu link √∫nico</li>
                            <li>‚Ä¢ PDFs podem ser diferentes</li>
                            <li>‚Ä¢ Salvo no Supabase Storage</li>
                            <li>‚Ä¢ Prote√ß√£o individual por convidado</li>
                            <li>‚Ä¢ <strong>üõ°Ô∏è Visualizador integrado seguro</strong></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Method 3: Generate Links Only -->
            <div id="linksOnly" class="space-y-6 hidden">
                <h3 class="text-lg font-medium text-gray-700">üîó M√©todo 3: Gerar Links Avulsos</h3>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">Nome dos Noivos</label>
                            <input type="text" id="coupleNames3" placeholder="Jo√£o & Maria" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">Data do Evento</label>
                            <input type="date" id="eventDate3" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">Nomes dos Convidados</label>
                            <textarea id="guestNames3" placeholder="Maria Silva&#10;Jo√£o Santos&#10;Ana Costa" 
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent h-32"></textarea>
                            <p class="text-xs text-gray-500 mt-1">Um nome por linha</p>
                        </div>
                        <button onclick="generateLinksOnly()" 
                                class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-6 rounded-lg transition-colors">
                            Gerar Links Avulsos
                        </button>
                    </div>
                    <div class="bg-purple-50 p-6 rounded-lg">
                        <h4 class="font-medium text-purple-800 mb-2">üí° M√©todo 3: Links Avulsos</h4>
                        <ul class="text-sm text-purple-700 space-y-1">
                            <li>‚Ä¢ Gera apenas links √∫nicos</li>
                            <li>‚Ä¢ Voc√™ usa os links onde quiser</li>
                            <li>‚Ä¢ Pode adicionar PDFs depois</li>
                            <li>‚Ä¢ Tudo controlado pelo Supabase</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Processing Results -->
            <div id="processingResults" class="space-y-6 hidden">
                <hr class="my-8">
                <h3 class="text-lg font-medium text-gray-700">üìã Resultados do Processamento</h3>
                <div id="currentInvitationInfo" class="bg-green-50 p-6 rounded-lg">
                    <!-- Processing results will be displayed here -->
                </div>
            </div>

            <!-- Generated Links -->
            <div id="generatedLinksSection" class="space-y-4 hidden">
                <hr class="my-8">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-700">üîó Links Gerados</h3>
                    <div class="flex gap-2">
                        <button onclick="exportAllLinks()" 
                                class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition-colors">
                            Exportar Lista de Links
                        </button>
                        <button onclick="loadInvitationStats()" 
                                class="bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition-colors">
                            Ver Estat√≠sticas
                        </button>
                    </div>
                </div>
                <div id="generatedLinks" class="space-y-3 max-h-96 overflow-y-auto">
                    <!-- Links will appear here -->
                </div>
            </div>
        </div>

        <!-- Invitation Viewer -->
        <div id="invitationViewer" class="bg-white rounded-2xl card-shadow p-8 hidden">
            <div id="invitationContent">
                <!-- Invitation content will be loaded here -->
            </div>
        </div>

        <!-- Access Denied -->
        <div id="accessDenied" class="bg-red-50 border border-red-200 rounded-2xl p-8 text-center hidden">
            <div class="text-red-600 text-6xl mb-4">üö´</div>
            <h2 class="text-2xl font-bold text-red-800 mb-2">Acesso Negado</h2>
            <p class="text-red-600 mb-4" id="accessDeniedMessage">Este convite n√£o est√° dispon√≠vel.</p>
            <p class="text-sm text-red-500">Por motivos de seguran√ßa, cada convite tem acesso controlado.</p>
        </div>

        <!-- Loading -->
        <div id="loadingScreen" class="bg-white rounded-2xl card-shadow p-8 text-center hidden">
            <div class="text-blue-600 text-6xl mb-4">‚è≥</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Carregando...</h2>
            <p class="text-gray-600">Verificando acesso ao convite...</p>
        </div>
    </div>

    <script>
        // Supabase client - Auto-connected
        const SUPABASE_URL = 'https://drmdjuewsarzhiwytnsy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRybWRqdWV3c2Fyemhpd3l0bnN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5MjE5OTgsImV4cCI6MjA3MTQ5Nzk5OH0.l1XKUSsp74sW5q_GMcVOSinHBum8c8X7TyPtsuMOMww';
        
        let supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentInvitationId = null;
        let currentUser = null;

        // Encryption key for offline storage
        const ENCRYPTION_KEY = 'secure_invitation_key_2024';

        // Simple encryption/decryption for offline storage
        function encryptData(data) {
            return btoa(JSON.stringify(data));
        }

        function decryptData(encryptedData) {
            try {
                return JSON.parse(atob(encryptedData));
            } catch {
                return null;
            }
        }

        // Test Supabase connection on startup
        async function testSupabaseConnection() {
            try {
                const { data, error } = await supabase.from('invitations').select('count').limit(1);
                if (error) {
                    console.error('Supabase connection error:', error);
                } else {
                    console.log('‚úÖ Supabase connected successfully');
                }
            } catch (error) {
                console.error('Supabase connection failed:', error);
            }
        }

        // Simplified admin functions - no login required

        // Toggle PDF upload options
        function togglePdfUpload() {
            const pdfType = document.querySelector('input[name="pdfType1"]:checked').value;
            const singleUpload = document.getElementById('singlePdfUpload1');
            const multipleUpload = document.getElementById('multiplePdfUpload1');
            
            if (pdfType === 'single') {
                singleUpload.classList.remove('hidden');
                multipleUpload.classList.add('hidden');
            } else {
                singleUpload.classList.add('hidden');
                multipleUpload.classList.remove('hidden');
            }
        }

        // Toggle guest input method
        function toggleGuestInput() {
            const manualInput = document.getElementById('manualGuestInput1');
            const fileInput = document.getElementById('guestListFile1');
            
            if (manualInput.classList.contains('hidden')) {
                manualInput.classList.remove('hidden');
                fileInput.value = '';
            } else {
                manualInput.classList.add('hidden');
                document.getElementById('guestNamesManual1').value = '';
            }
        }

        // Generate unique device fingerprint
        function generateDeviceFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('Device fingerprint', 2, 2);
            
            const fingerprint = [
                navigator.userAgent,
                navigator.language,
                screen.width + 'x' + screen.height,
                new Date().getTimezoneOffset(),
                canvas.toDataURL(),
                navigator.hardwareConcurrency || 'unknown',
                navigator.deviceMemory || 'unknown'
            ].join('|');
            
            return btoa(fingerprint).substring(0, 32);
        }

        // Generate unique token
        function generateToken() {
            return 'tok_' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        // Normalize name for intelligent matching
        function normalizeName(name) {
            return name
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Remove accents
                .replace(/[^a-z\s]/g, '') // Remove special characters
                .replace(/\s+/g, ' ') // Replace multiple spaces with single space
                .trim();
        }

        // Intelligent name matching
        function matchName(inputName, targetName) {
            const normalizedInput = normalizeName(inputName);
            const normalizedTarget = normalizeName(targetName);
            
            // Exact match
            if (normalizedInput === normalizedTarget) {
                return true;
            }
            
            // Split names into words
            const inputWords = normalizedInput.split(' ').filter(word => word.length > 0);
            const targetWords = normalizedTarget.split(' ').filter(word => word.length > 0);
            
            // Check if all input words are present in target
            const allWordsMatch = inputWords.every(inputWord => 
                targetWords.some(targetWord => 
                    targetWord.includes(inputWord) || inputWord.includes(targetWord)
                )
            );
            
            // Check if at least 2 words match (for longer names)
            const matchingWords = inputWords.filter(inputWord => 
                targetWords.some(targetWord => 
                    targetWord.includes(inputWord) || inputWord.includes(targetWord)
                )
            );
            
            // Return true if all words match OR at least 2 words match and it's more than 50% of input
            return allWordsMatch || (matchingWords.length >= 2 && matchingWords.length >= inputWords.length * 0.5);
        }

        // Method selection
        function selectMethod(method) {
            // Hide all methods
            document.getElementById('bulkUpload').classList.add('hidden');
            document.getElementById('multipleUpload').classList.add('hidden');
            document.getElementById('linksOnly').classList.add('hidden');
            
            // Reset button styles
            document.querySelectorAll('.method-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50', 'border-green-500', 'bg-green-50', 'border-purple-500', 'bg-purple-50');
                btn.classList.add('border-gray-300');
            });
            
            // Show selected method and highlight button
            if (method === 'bulk') {
                document.getElementById('bulkUpload').classList.remove('hidden');
                document.getElementById('bulkMethod').classList.add('border-blue-500', 'bg-blue-50');
            } else if (method === 'multiple') {
                document.getElementById('multipleUpload').classList.remove('hidden');
                document.getElementById('multipleMethod').classList.add('border-green-500', 'bg-green-50');
            } else if (method === 'links') {
                document.getElementById('linksOnly').classList.remove('hidden');
                document.getElementById('linksMethod').classList.add('border-purple-500', 'bg-purple-50');
            }
        }

        // üîí SISTEMA DE SEGURAN√áA APRIMORADO
        // Upload file to Supabase Storage (PRIVADO)
        async function uploadFileToSupabase(file, fileName) {
            if (!supabase) {
                throw new Error('Supabase n√£o conectado');
            }

            const { data, error } = await supabase.storage
                .from('invitations-private')
                .upload(fileName, file);

            if (error) {
                throw error;
            }

            // Retorna apenas o nome do arquivo (n√£o a URL p√∫blica)
            return fileName;
        }

        // Gerar URL assinada tempor√°ria (v√°lida por 1 hora)
        async function getSecurePdfUrl(fileName) {
            if (!supabase || !fileName) {
                return null;
            }

            try {
                const { data, error } = await supabase.storage
                    .from('invitations-private')
                    .createSignedUrl(fileName, 3600); // 1 hora

                if (error) {
                    console.error('Erro ao gerar URL assinada:', error);
                    return null;
                }

                return data.signedUrl;
            } catch (error) {
                console.error('Erro ao gerar URL assinada:', error);
                return null;
            }
        }

        // Method 1: Bulk processing
        async function processBulkInvitation() {
            if (!supabase) {
                alert('Por favor, conecte ao Supabase primeiro.');
                return;
            }

            const coupleNames = document.getElementById('coupleNames1').value;
            const eventDate = document.getElementById('eventDate1').value;
            const validationType = document.querySelector('input[name="validationType1"]:checked').value;
            const pdfType = document.querySelector('input[name="pdfType1"]:checked').value;

            if (!coupleNames || !eventDate) {
                alert('Por favor, preencha nome dos noivos e data do evento.');
                return;
            }

            // Get guest names
            let guestNames = [];
            const guestListFile = document.getElementById('guestListFile1').files[0];
            const manualGuestNames = document.getElementById('guestNamesManual1').value.trim();

            if (guestListFile) {
                const guestListText = await readFileAsText(guestListFile);
                guestNames = guestListText.split('\n')
                    .map(name => name.trim())
                    .filter(name => name.length > 0);
            } else if (manualGuestNames) {
                guestNames = manualGuestNames.split('\n')
                    .map(name => name.trim())
                    .filter(name => name.length > 0);
            } else {
                alert('Por favor, forne√ßa a lista de convidados (arquivo TXT ou digitada).');
                return;
            }

            if (guestNames.length === 0) {
                alert('A lista de convidados est√° vazia.');
                return;
            }

            try {
                showLoading('Processando convite bulk...');

                let pdfFileName = null;
                let guestLinks = [];

                if (pdfType === 'single') {
                    // Single PDF for all guests
                    const singlePdfFile = document.getElementById('singlePdfFile1').files[0];
                    
                    if (singlePdfFile) {
                        const fileName = `${Date.now()}_${singlePdfFile.name}`;
                        pdfFileName = await uploadFileToSupabase(singlePdfFile, fileName);
                    }

                    // Create invitation in database
                    const { data: invitation, error: invError } = await supabase
                        .from('invitations')
                        .insert({
                            couple_names: coupleNames,
                            event_date: eventDate,
                            pdf_file_name: pdfFileName // Armazena nome do arquivo, n√£o URL
                        })
                        .select()
                        .single();

                    if (invError) throw invError;
                    currentInvitationId = invitation.id;

                    // Create guest links (all pointing to same PDF)
                    guestLinks = guestNames.map(guestName => ({
                        invitation_id: invitation.id,
                        guest_name: guestName,
                        normalized_name: normalizeName(guestName),
                        link_token: generateToken(),
                        validation_type: validationType
                    }));

                } else {
                    // Multiple PDFs - one for each guest
                    const multiplePdfFiles = document.getElementById('multiplePdfFiles1').files;
                    
                    if (multiplePdfFiles.length !== guestNames.length) {
                        alert(`N√∫mero de PDFs (${multiplePdfFiles.length}) deve ser igual ao n√∫mero de convidados (${guestNames.length}).`);
                        hideLoading();
                        return;
                    }

                    // Create main invitation
                    const { data: invitation, error: invError } = await supabase
                        .from('invitations')
                        .insert({
                            couple_names: coupleNames,
                            event_date: eventDate,
                            pdf_file_name: null // Multiple PDFs, no single file
                        })
                        .select()
                        .single();

                    if (invError) throw invError;
                    currentInvitationId = invitation.id;

                    // Process each PDF and create guest links
                    for (let i = 0; i < multiplePdfFiles.length; i++) {
                        const pdfFile = multiplePdfFiles[i];
                        const guestName = guestNames[i];
                        
                        // Upload PDF
                        const fileName = `${Date.now()}_${i}_${pdfFile.name}`;
                        const individualPdfFileName = await uploadFileToSupabase(pdfFile, fileName);
                        
                        // Create guest link with individual PDF
                        guestLinks.push({
                            invitation_id: invitation.id,
                            guest_name: guestName,
                            normalized_name: normalizeName(guestName),
                            link_token: generateToken(),
                            validation_type: validationType,
                            pdf_file_name: individualPdfFileName // Individual PDF file name
                        });
                    }
                }

                // Insert all guest links
                const { data: links, error: linksError } = await supabase
                    .from('guest_links')
                    .insert(guestLinks)
                    .select();

                if (linksError) throw linksError;

                // Get the invitation data for display
                const { data: finalInvitation } = await supabase
                    .from('invitations')
                    .select('*')
                    .eq('id', currentInvitationId)
                    .single();

                hideLoading();
                showProcessingResults(finalInvitation, links);
                
                const pdfTypeText = pdfType === 'single' ? '1 PDF para todos' : 'PDFs individuais';
                alert(`Processamento bulk conclu√≠do!\n\n${guestNames.length} links gerados\nTipo: ${pdfTypeText}\nüõ°Ô∏è VISUALIZADOR INTEGRADO - Imposs√≠vel compartilhar URLs`);

            } catch (error) {
                console.error('Erro no processamento bulk:', error);
                alert('Erro no processamento: ' + error.message);
                hideLoading();
            }
        }

        // Method 2: Multiple PDFs processing
        async function processMultiplePDFs() {
            if (!supabase) {
                alert('Por favor, conecte ao Supabase primeiro.');
                return;
            }

            const coupleNames = document.getElementById('coupleNames2').value;
            const eventDate = document.getElementById('eventDate2').value;
            const pdfFiles = document.getElementById('multiplePdfFiles').files;
            const guestNamesText = document.getElementById('guestNames2').value;

            if (!coupleNames || !eventDate || pdfFiles.length === 0 || !guestNamesText.trim()) {
                alert('Por favor, preencha todos os campos e selecione os PDFs.');
                return;
            }

            const guestNames = guestNamesText.split('\n')
                .map(name => name.trim())
                .filter(name => name.length > 0);

            if (guestNames.length !== pdfFiles.length) {
                alert('O n√∫mero de nomes deve ser igual ao n√∫mero de PDFs.');
                return;
            }

            try {
                showLoading('Processando m√∫ltiplos PDFs...');

                // Create main invitation
                const { data: invitation, error: invError } = await supabase
                    .from('invitations')
                    .insert({
                        couple_names: coupleNames,
                        event_date: eventDate,
                        pdf_file_name: null // Multiple PDFs, no single file
                    })
                    .select()
                    .single();

                if (invError) {
                    throw invError;
                }

                currentInvitationId = invitation.id;

                // Process each PDF and create guest links
                const guestLinks = [];
                for (let i = 0; i < pdfFiles.length; i++) {
                    const pdfFile = pdfFiles[i];
                    const guestName = guestNames[i];
                    
                    // Upload PDF
                    const fileName = `${Date.now()}_${i}_${pdfFile.name}`;
                    const pdfFileName = await uploadFileToSupabase(pdfFile, fileName);
                    
                    // Create guest link with individual PDF
                    const { data: link, error: linkError } = await supabase
                        .from('guest_links')
                        .insert({
                            invitation_id: invitation.id,
                            guest_name: guestName,
                            normalized_name: normalizeName(guestName),
                            link_token: generateToken(),
                            validation_type: 'name',
                            pdf_file_name: pdfFileName // Individual PDF file name
                        })
                        .select()
                        .single();

                    if (linkError) {
                        throw linkError;
                    }

                    guestLinks.push(link);
                }

                hideLoading();
                showProcessingResults(invitation, guestLinks);
                alert(`Processamento conclu√≠do! ${pdfFiles.length} PDFs processados com sucesso.\nüõ°Ô∏è Visualizador integrado - Imposs√≠vel compartilhar URLs.`);

            } catch (error) {
                console.error('Erro no processamento:', error);
                alert('Erro no processamento: ' + error.message);
                hideLoading();
            }
        }

        // Method 3: Generate links only
        async function generateLinksOnly() {
            if (!supabase) {
                alert('Por favor, conecte ao Supabase primeiro.');
                return;
            }

            const coupleNames = document.getElementById('coupleNames3').value;
            const eventDate = document.getElementById('eventDate3').value;
            const guestNamesText = document.getElementById('guestNames3').value;

            if (!coupleNames || !eventDate || !guestNamesText.trim()) {
                alert('Por favor, preencha todos os campos obrigat√≥rios.');
                return;
            }

            const guestNames = guestNamesText.split('\n')
                .map(name => name.trim())
                .filter(name => name.length > 0);

            try {
                showLoading('Gerando links...');

                // Create invitation
                const { data: invitation, error: invError } = await supabase
                    .from('invitations')
                    .insert({
                        couple_names: coupleNames,
                        event_date: eventDate,
                        pdf_file_name: null // No PDF yet
                    })
                    .select()
                    .single();

                if (invError) {
                    throw invError;
                }

                currentInvitationId = invitation.id;

                // Create guest links
                const guestLinks = guestNames.map(guestName => ({
                    invitation_id: invitation.id,
                    guest_name: guestName,
                    normalized_name: normalizeName(guestName),
                    link_token: generateToken(),
                    validation_type: 'name'
                }));

                const { data: links, error: linksError } = await supabase
                    .from('guest_links')
                    .insert(guestLinks)
                    .select();

                if (linksError) {
                    throw linksError;
                }

                hideLoading();
                showProcessingResults(invitation, links);
                alert(`Processamento conclu√≠do! ${guestNames.length} links gerados com sucesso.`);

            } catch (error) {
                console.error('Erro no processamento:', error);
                alert('Erro no processamento: ' + error.message);
                hideLoading();
            }
        }

        // Show processing results
        function showProcessingResults(invitation, links) {
            document.getElementById('processingResults').classList.remove('hidden');
            document.getElementById('generatedLinksSection').classList.remove('hidden');
            
            document.getElementById('currentInvitationInfo').innerHTML = `
                <h4 class="font-medium text-green-800 mb-2">‚úÖ Processamento Conclu√≠do</h4>
                <p class="text-sm text-green-700 mb-1"><strong>Noivos:</strong> ${invitation.couple_names}</p>
                <p class="text-sm text-green-700 mb-1"><strong>Data:</strong> ${new Date(invitation.event_date).toLocaleDateString('pt-BR')}</p>
                <p class="text-sm text-green-700 mb-1"><strong>Links gerados:</strong> ${links.length}</p>
                <p class="text-sm text-green-700 mb-3"><strong>Banco:</strong> Tudo salvo no Supabase</p>
                
                <div class="bg-white p-4 rounded border-l-4 border-blue-500">
                    <h5 class="font-medium text-blue-800 mb-2">üõ°Ô∏è VISUALIZADOR INTEGRADO ATIVO:</h5>
                    <div class="text-xs text-blue-700 space-y-1">
                        <p><strong>1. Imposs√≠vel Compartilhar:</strong> PDFs abrem dentro do sistema</p>
                        <p><strong>2. Sem URLs Copi√°veis:</strong> N√£o h√° links externos para copiar</p>
                        <p><strong>3. Prote√ß√£o Anti-Screenshot:</strong> Detecta tentativas de captura</p>
                        <p><strong>4. Links Interativos:</strong> Hiperlinks do PDF funcionam normalmente</p>
                        <p><strong>5. Sem Limita√ß√£o de Tempo:</strong> Acesso permanente ap√≥s valida√ß√£o</p>
                        <p><strong>6. üîí SEGURAN√áA M√ÅXIMA:</strong> Imposs√≠vel burlar ou extrair</p>
                    </div>
                </div>
            `;

            // Display links
            const linksContainer = document.getElementById('generatedLinks');
            linksContainer.innerHTML = '';
            
            links.forEach((link, index) => {
                displayGuestLink(link, index + 1);
            });
        }

        // Display guest link
        function displayGuestLink(link, number) {
            const linksContainer = document.getElementById('generatedLinks');
            const guestUrl = `${window.location.origin}${window.location.pathname}?token=${link.link_token}`;
            
            const linkElement = document.createElement('div');
            linkElement.className = 'bg-gray-50 p-4 rounded-lg border';
            linkElement.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h4 class="font-medium text-gray-800">${link.guest_name}</h4>
                        <p class="text-xs text-gray-500">Link #${number}</p>
                        <p class="text-xs text-green-600">‚úÖ Salvo no Supabase</p>
                        ${link.pdf_file_name ? '<p class="text-xs text-blue-600">üìÑ PDF individual protegido</p>' : ''}
                        <p class="text-xs text-blue-600">üõ°Ô∏è Visualizador integrado - Imposs√≠vel compartilhar</p>
                    </div>
                    <span class="text-xs text-gray-500">${new Date(link.created_at).toLocaleDateString('pt-BR')}</span>
                </div>
                <div class="bg-white p-2 rounded border text-sm font-mono text-gray-600 mb-2 break-all">
                    ${guestUrl}
                </div>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="copyToClipboard('${guestUrl}')" 
                            class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200 transition-colors">
                        Copiar Link
                    </button>
                    <button onclick="copyWhatsAppMessage('${link.guest_name}', '${guestUrl}')" 
                            class="text-xs bg-green-100 text-green-700 px-3 py-1 rounded hover:bg-green-200 transition-colors">
                        Copiar Msg WhatsApp
                    </button>
                    <button onclick="viewGuestStats('${link.id}')" 
                            class="text-xs bg-gray-100 text-gray-700 px-3 py-1 rounded hover:bg-gray-200 transition-colors">
                        Ver Status
                    </button>
                </div>
            `;
            
            linksContainer.appendChild(linkElement);
        }

        // Copy WhatsApp message
        function copyWhatsAppMessage(guestName, guestUrl) {
            const message = `Oi ${guestName}! üíí

Aqui est√° o seu convite de casamento:

üîó *Link personalizado:*
${guestUrl}

‚ö†Ô∏è *IMPORTANTE:* Este link √© √∫nico e s√≥ funciona com seu nome. Clique nele e digite seu nome exatamente como cadastrado.

üõ°Ô∏è *SEGURAN√áA M√ÅXIMA:* O convite abre em visualizador protegido e n√£o pode ser compartilhado.

Nos vemos na festa! üéâ`;

            navigator.clipboard.writeText(message).then(() => {
                alert('Mensagem do WhatsApp copiada!');
            });
        }

        // Copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Link copiado para a √°rea de transfer√™ncia!');
            });
        }

        // View guest statistics
        async function viewGuestStats(linkId) {
            if (!supabase) return;

            try {
                const { data: link, error } = await supabase
                    .from('guest_links')
                    .select('*')
                    .eq('id', linkId)
                    .single();

                if (error) throw error;

                const status = link.name_validated ? 'Acessado' : 'Aguardando acesso';
                const accessInfo = link.name_validated ? 
                    `Acessos: ${link.access_count}\nPrimeiro acesso: ${new Date(link.first_access).toLocaleString('pt-BR')}` : 
                    'Ainda n√£o foi acessado';
                
                alert(`Status: ${link.guest_name}\n\n${status}\n${accessInfo}`);
            } catch (error) {
                console.error('Erro ao buscar estat√≠sticas:', error);
            }
        }

        // Export all links
        function exportAllLinks() {
            // Implementation for exporting links
            alert('Funcionalidade de exporta√ß√£o ser√° implementada');
        }

        // Load invitation statistics
        async function loadInvitationStats() {
            if (!supabase || !currentInvitationId) return;

            try {
                const { data: links, error } = await supabase
                    .from('guest_links')
                    .select('*')
                    .eq('invitation_id', currentInvitationId);

                if (error) throw error;

                const total = links.length;
                const accessed = links.filter(link => link.name_validated).length;
                const pending = total - accessed;

                alert(`Estat√≠sticas do Convite:\n\nTotal de links: ${total}\nAcessados: ${accessed}\nPendentes: ${pending}`);
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
            }
        }

        // Admin authentication functions
        async function authenticateAdmin() {
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            const errorDiv = document.getElementById('loginError');
            
            if (!username || !password) {
                showLoginError('Por favor, preencha usu√°rio e senha.');
                return;
            }
            
            try {
                // Verificar credenciais no Supabase
                const { data: admin, error } = await supabase
                    .from('admin_users')
                    .select('*')
                    .eq('username', username)
                    .eq('password', password)
                    .eq('active', true)
                    .single();
                
                if (error || !admin) {
                    showLoginError('Usu√°rio ou senha incorretos.');
                    return;
                }
                
                // Login bem-sucedido
                sessionStorage.setItem('admin_authenticated', 'true');
                sessionStorage.setItem('admin_user', admin.username);
                
                // Esconder tela de login e mostrar painel
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                
                // Limpar campos
                document.getElementById('adminUsername').value = '';
                document.getElementById('adminPassword').value = '';
                errorDiv.classList.add('hidden');
                
                console.log('‚úÖ Admin autenticado:', admin.username);
                
            } catch (error) {
                console.error('Erro na autentica√ß√£o:', error);
                showLoginError('Erro de conex√£o. Tente novamente.');
            }
        }
        
        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            
            // Limpar erro ap√≥s 5 segundos
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }
        
        function logoutAdmin() {
            sessionStorage.removeItem('admin_authenticated');
            sessionStorage.removeItem('admin_user');
            
            // Mostrar tela de login e esconder painel
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            
            console.log('üîì Admin deslogado');
        }
        
        function checkAdminAuth() {
            const isAuthenticated = sessionStorage.getItem('admin_authenticated');
            
            if (isAuthenticated === 'true') {
                // Admin j√° est√° logado
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                return true;
            } else {
                // N√£o est√° logado - mostrar tela de login
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('adminPanel').classList.add('hidden');
                return false;
            }
        }

        // Check guest access - CORRIGIDO
        async function checkGuestAccess() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            console.log('üîç Verificando URL:', window.location.href);
            console.log('üîç Par√¢metros URL:', window.location.search);
            console.log('üîç Token encontrado:', token);
            
            // VERIFICA√á√ÉO CORRIGIDA - token deve existir e n√£o ser vazio
            if (token && token.trim() !== '') {
                console.log('‚úÖ √â um link de convidado - processando token:', token);
                
                // üõ°Ô∏è PROTE√á√ÉO M√ÅXIMA - IMPEDIR C√ìPIA DE URL
                implementMaximumSecurity(token);
                
                // ATIVAR PROTE√á√ïES APENAS PARA CONVIDADOS
                initializeProtection();
                addWatermark();
                
                // Hide login screen and admin panel for guests
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'none';
                
                showLoading('Verificando acesso...');

                try {
                    // üöÄ ACESSO DIRETO PARA USU√ÅRIOS VALIDADOS
                    // Primeiro, verifica se j√° tem dados em cache
                    const cachedData = getCachedInvitationData(token);
                    
                    // Se tem cache E o usu√°rio j√° foi validado, mostra PDF diretamente
                    if (cachedData && cachedData.name_validated) {
                        console.log('üîÑ Usu√°rio j√° validado - abrindo PDF diretamente...');
                        hideLoading();
                        showCachedInvitationDirectly(cachedData);
                        
                        // Tenta atualizar em background se online
                        updateCacheInBackground(token);
                        return;
                    }

                    // Supabase is always connected

                    const { data: link, error } = await supabase
                        .from('guest_links')
                        .select(`
                            *,
                            invitations (*)
                        `)
                        .eq('link_token', token)
                        .single();

                    if (error || !link) {
                        throw new Error('Link de convite n√£o encontrado');
                    }

                    hideLoading();

                    // Check if name validation is required
                    if (link.validation_type === 'name' && !link.name_validated) {
                        showNameValidation(link);
                    } else if (link.validation_type === 'device') {
                        // Device validation logic
                        const currentFingerprint = generateDeviceFingerprint();
                        
                        if (!link.authorized_device) {
                            // First access - authorize device
                            await authorizeDevice(link.id, currentFingerprint);
                            showInvitationDirectly(link);
                        } else if (link.authorized_device === currentFingerprint) {
                            // Authorized device - show PDF directly
                            await incrementAccessCount(link.id);
                            showInvitationDirectly(link);
                        } else {
                            // Unauthorized device
                            showAccessDenied('Este convite s√≥ pode ser visualizado no dispositivo autorizado.');
                        }
                    } else {
                        // Already validated - cache and show PDF directly
                        cacheInvitationData(token, link);
                        showInvitationDirectly(link);
                    }

                } catch (error) {
                    console.error('Erro ao verificar acesso:', error);
                    hideLoading();
                    
                    // Se tem cache, mostra mesmo com erro de conex√£o
                    const cachedData = getCachedInvitationData(token);
                    if (cachedData && cachedData.name_validated) {
                        console.log('üì± Modo offline - usando dados em cache');
                        showCachedInvitation(cachedData);
                    } else {
                        showAccessDenied('Erro de conex√£o: ' + error.message);
                    }
                }
            } else {
                // N√£o √© convidado - verificar se admin est√° logado
                console.log('‚ùå N√£o √© um link de convidado - mostrando tela de admin');
                checkAdminAuth();
            }
        }

        // Update cache in background (for online users)
        async function updateCacheInBackground(token) {
            try {
                if (!supabase) return;
                
                const { data: link, error } = await supabase
                    .from('guest_links')
                    .select(`
                        *,
                        invitations (*)
                    `)
                    .eq('link_token', token)
                    .single();

                if (!error && link) {
                    // Update cache with fresh data
                    cacheInvitationData(token, link);
                    console.log('üîÑ Cache atualizado em background');
                }
            } catch (error) {
                console.log('Background update failed (normal in offline mode)');
            }
        }

        // Show name validation screen
        function showNameValidation(link) {
            const viewer = document.getElementById('invitationViewer');
            const content = document.getElementById('invitationContent');
            
            content.innerHTML = `
                <div class="text-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">üíí ${link.invitations.couple_names}</h2>
                    <p class="text-gray-600">Data: ${new Date(link.invitations.event_date).toLocaleDateString('pt-BR')}</p>
                </div>
                
                <div class="bg-blue-50 rounded-lg p-6 text-center mb-6">
                    <div class="text-4xl mb-4">üîê</div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Valida√ß√£o de Acesso</h3>
                    <p class="text-gray-600 mb-6">Para acessar seu convite, digite seu nome completo:</p>
                    
                    <div class="max-w-md mx-auto">
                        <input type="text" id="nameInput" placeholder="Digite seu nome completo" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-4">
                        <button onclick="validateName('${link.id}', '${link.link_token}')" 
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-colors">
                            Acessar Convite
                        </button>
                    </div>
                    
                    <div id="nameError" class="text-red-600 text-sm mt-4 hidden"></div>
                </div>
                
                <div class="text-center">
                    <p class="text-sm text-gray-500">
                        üîí Este convite √© protegido. Digite seu nome exatamente como foi cadastrado.
                    </p>
                    <p class="text-xs text-gray-400 mt-2">
                        Exemplo: Se foi cadastrado "Jo√£o Silva Santos", voc√™ pode digitar "Jo√£o Silva" ou "jo√£o silva santos"
                    </p>
                </div>
            `;
            
            viewer.classList.remove('hidden');
            
            // Focus on input and add enter key listener
            setTimeout(() => {
                const nameInput = document.getElementById('nameInput');
                nameInput.focus();
                nameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        validateName(link.id, link.link_token);
                    }
                });
            }, 100);
        }

        // Validate entered name
        async function validateName(linkId, token) {
            const inputName = document.getElementById('nameInput').value.trim();
            const errorDiv = document.getElementById('nameError');
            
            if (!inputName) {
                errorDiv.textContent = 'Por favor, digite seu nome.';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                // Supabase is always connected

                // Get current link data
                const { data: link, error: linkError } = await supabase
                    .from('guest_links')
                    .select(`
                        *,
                        invitations (*)
                    `)
                    .eq('id', linkId)
                    .single();

                if (linkError || !link) {
                    throw new Error('Link n√£o encontrado');
                }

                // Check if already validated
                if (link.name_validated) {
                    errorDiv.textContent = 'Este convite j√° foi acessado.';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                // Get all guest names for this invitation
                const { data: allLinks, error: allLinksError } = await supabase
                    .from('guest_links')
                    .select('guest_name, name_validated')
                    .eq('invitation_id', link.invitation_id);

                if (allLinksError) {
                    throw new Error('Erro ao verificar nomes');
                }

                // Check if name matches and is available
                let matchFound = false;
                for (const otherLink of allLinks) {
                    if (matchName(inputName, otherLink.guest_name)) {
                        if (!otherLink.name_validated || otherLink.guest_name === link.guest_name) {
                            matchFound = true;
                            break;
                        }
                    }
                }

                if (matchFound) {
                    // Validate the name
                    const { error: updateError } = await supabase
                        .from('guest_links')
                        .update({
                            name_validated: true,
                            access_count: 1,
                            first_access: new Date().toISOString(),
                            authorized_device: generateDeviceFingerprint()
                        })
                        .eq('id', linkId);

                    if (updateError) {
                        throw updateError;
                    }

                    // Cache data for offline access
                    cacheInvitationData(token, {
                        ...link,
                        name_validated: true,
                        access_count: 1,
                        first_access: new Date().toISOString()
                    });

                    // Reload link data and show PDF directly
                    const { data: updatedLink } = await supabase
                        .from('guest_links')
                        .select(`
                            *,
                            invitations (*)
                        `)
                        .eq('id', linkId)
                        .single();

                    showInvitationDirectly(updatedLink);

                } else {
                    errorDiv.textContent = 'Nome n√£o encontrado na lista de convidados ou j√° foi utilizado.';
                    errorDiv.classList.remove('hidden');
                    
                    // Clear input for retry
                    document.getElementById('nameInput').value = '';
                    document.getElementById('nameInput').focus();
                }

            } catch (error) {
                console.error('Erro na valida√ß√£o:', error);
                errorDiv.textContent = 'Erro na valida√ß√£o. Tente novamente.';
                errorDiv.classList.remove('hidden');
            }
        }

        // Cache invitation data for offline access
        function cacheInvitationData(token, linkData) {
            const cacheKey = `invitation_${token}`;
            const encryptedData = encryptData({
                ...linkData,
                cached_at: new Date().toISOString()
            });
            localStorage.setItem(cacheKey, encryptedData);
        }

        // Get cached invitation data
        function getCachedInvitationData(token) {
            const cacheKey = `invitation_${token}`;
            const encryptedData = localStorage.getItem(cacheKey);
            if (encryptedData) {
                const data = decryptData(encryptedData);
                if (data && data.name_validated) {
                    return data;
                }
            }
            return null;
        }

        // Show cached invitation (offline mode)
        function showCachedInvitation(cachedData) {
            showInvitation(cachedData, true);
        }

        // Show cached invitation directly (open PDF immediately)
        async function showCachedInvitationDirectly(cachedData) {
            // Determine which PDF file to show
            const pdfFileName = cachedData.pdf_file_name || cachedData.invitations.pdf_file_name;
            
            if (pdfFileName) {
                // Generate secure URL and open PDF directly
                const secureUrl = await getSecurePdfUrl(pdfFileName);
                if (secureUrl) {
                    showIntegratedPDFViewer(secureUrl);
                    return;
                }
            }
            
            // Fallback to regular invitation view if no PDF
            showInvitation(cachedData, true);
        }

        // Show invitation directly (open PDF immediately for validated users)
        async function showInvitationDirectly(link) {
            // Determine which PDF file to show
            const pdfFileName = link.pdf_file_name || link.invitations.pdf_file_name;
            
            if (pdfFileName) {
                // Generate secure URL and open PDF directly
                const secureUrl = await getSecurePdfUrl(pdfFileName);
                if (secureUrl) {
                    showIntegratedPDFViewer(secureUrl);
                    
                    // Cache data for future direct access
                    cacheInvitationData(link.link_token, link);
                    
                    // Increment access count
                    if (supabase) {
                        incrementAccessCount(link.id);
                    }
                    return;
                }
            }
            
            // Fallback to regular invitation view if no PDF
            showInvitation(link);
        }

        // Show invitation content
        async function showInvitation(link, isOffline = false) {
            const viewer = document.getElementById('invitationViewer');
            const content = document.getElementById('invitationContent');
            
            const offlineIndicator = isOffline ? 
                '<div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded mb-4">üì± Modo Offline - Dados em cache</div>' : '';
            
            const guestWelcome = `<p class="text-lg text-gray-600 mb-4">Ol√°, ${link.guest_name}!</p>`;
            
            // Determine which PDF file to show
            const pdfFileName = link.pdf_file_name || link.invitations.pdf_file_name;
            
            // Generate secure URL if PDF exists and user is online
            let secureUrl = null;
            if (pdfFileName && !isOffline) {
                secureUrl = await getSecurePdfUrl(pdfFileName);
            }
            
            content.innerHTML = `
                ${offlineIndicator}
                <div class="text-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">üíí ${link.invitations.couple_names}</h2>
                    ${guestWelcome}
                    <p class="text-gray-600">Data: ${new Date(link.invitations.event_date).toLocaleDateString('pt-BR')}</p>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-6 text-center">
                    <div class="text-6xl mb-4">üõ°Ô∏è</div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Convite Digital Ultra-Seguro</h3>
                    <p class="text-gray-600 mb-4">Visualizador integrado com prote√ß√£o m√°xima.</p>
                    ${secureUrl ? 
                        `<button onclick="viewSecurePDF('${secureUrl}')" 
                                class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-colors mb-2">
                            üõ°Ô∏è Visualizar Convite Seguro
                        </button>
                        <p class="text-xs text-green-600 mt-2">‚úÖ Visualizador integrado - Imposs√≠vel compartilhar</p>` : 
                        (pdfFileName ? 
                            '<p class="text-gray-500">PDF dispon√≠vel apenas online</p>' :
                            '<p class="text-gray-500">PDF ser√° disponibilizado em breve</p>')
                    }
                </div>
                
                <div class="mt-6 text-center">
                    <p class="text-sm text-gray-500">
                        üõ°Ô∏è Este convite √© ultra-seguro. Abre em visualizador protegido.
                    </p>
                    <p class="text-xs text-gray-400 mt-2">Acessos: ${link.access_count || 1}</p>
                    ${link.pdf_file_name ? '<p class="text-xs text-blue-500 mt-1">üìÑ PDF personalizado protegido</p>' : ''}
                    <p class="text-xs text-green-500 mt-1">üõ°Ô∏è Imposs√≠vel copiar URLs ou compartilhar</p>
                </div>
            `;
            
            viewer.classList.remove('hidden');

            // Increment access count if online
            if (!isOffline && supabase) {
                incrementAccessCount(link.id);
            }
        }

        // Increment access count
        async function incrementAccessCount(linkId) {
            try {
                await supabase
                    .from('guest_links')
                    .update({
                        access_count: supabase.sql`access_count + 1`
                    })
                    .eq('id', linkId);
            } catch (error) {
                console.error('Erro ao incrementar contador:', error);
            }
        }

        // Authorize device
        async function authorizeDevice(linkId, fingerprint) {
            try {
                await supabase
                    .from('guest_links')
                    .update({
                        authorized_device: fingerprint,
                        access_count: 1,
                        first_access: new Date().toISOString()
                    })
                    .eq('id', linkId);
            } catch (error) {
                console.error('Erro ao autorizar dispositivo:', error);
            }
        }

        // üõ°Ô∏è VISUALIZADOR PDF INTEGRADO - M√ÅXIMA SEGURAN√áA
        function viewSecurePDF(secureUrl) {
            if (secureUrl) {
                showIntegratedPDFViewer(secureUrl);
            }
        }

        function showIntegratedPDFViewer(pdfUrl) {
            const overlay = document.createElement('div');
            overlay.id = 'pdfViewerOverlay';
            overlay.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
                background: #000; z-index: 99999; display: flex; flex-direction: column;
                user-select: none; -webkit-user-select: none;
            `;

            const header = document.createElement('div');
            header.style.cssText = `
                background: #1f2937; color: white; padding: 15px 20px;
                display: flex; justify-content: space-between; align-items: center;
            `;
            header.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="font-size: 24px;">üõ°Ô∏è</div>
                    <div>
                        <h3 style="margin: 0; font-size: 18px;">Convite Digital Ultra-Protegido</h3>
                        <p style="margin: 0; font-size: 12px; color: #9ca3af;">Imposs√≠vel compartilhar ou copiar</p>
                    </div>
                </div>
                <button onclick="closePDFViewer()" style="
                    background: #dc2626; color: white; border: none;
                    padding: 8px 16px; border-radius: 6px; cursor: pointer;
                ">‚úï Fechar</button>
            `;

            const pdfContainer = document.createElement('div');
            pdfContainer.style.cssText = `
                flex: 1; position: relative; background: #374151;
                display: flex; justify-content: center; align-items: center;
            `;

            const iframe = document.createElement('iframe');
            iframe.style.cssText = `
                width: 100%; height: 100%; border: none; background: white;
            `;
            // Configure PDF to hide all toolbars and controls
            const pdfUrlWithParams = pdfUrl + '#toolbar=0&navpanes=0&scrollbar=0&statusbar=0&messages=0&scrollbar=0&view=FitH';
            iframe.src = pdfUrlWithParams;

            // No watermark overlay to preserve PDF interactivity
            pdfContainer.appendChild(iframe);

            const footer = document.createElement('div');
            footer.style.cssText = `
                background: #1f2937; color: #9ca3af; padding: 10px 20px;
                text-align: center; font-size: 12px;
            `;
            footer.innerHTML = `üõ°Ô∏è VISUALIZA√á√ÉO ULTRA-SEGURA ‚Ä¢ Imposs√≠vel copiar URL ‚Ä¢ Links interativos funcionais ‚Ä¢ Prote√ß√£o anti-screenshot`;

            overlay.appendChild(header);
            overlay.appendChild(pdfContainer);
            overlay.appendChild(footer);
            document.body.appendChild(overlay);

            applyViewerProtections(overlay);

            // Session remains active without time limit
        }

        function applyViewerProtections(element) {
            // Only essential protections - no annoying alerts
            element.addEventListener('contextmenu', function(e) {
                e.preventDefault();
            });

            element.addEventListener('keydown', function(e) {
                if (e.key === 'PrintScreen' || 
                    (e.ctrlKey && ['p', 's'].includes(e.key)) ||
                    e.key === 'F12') {
                    e.preventDefault();
                    return false;
                }
            });

            window.addEventListener('beforeprint', function(e) {
                e.preventDefault();
            });
        }

        function showProtectionAlert(customMessage = null) {
            const message = customMessage || 'A√á√ÉO BLOQUEADA POR SEGURAN√áA';
            const alertOverlay = document.createElement('div');
            alertOverlay.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
                background: rgba(0,0,0,0.9); z-index: 999999;
                display: flex; justify-content: center; align-items: center;
                color: white; font-size: 24px; text-align: center; font-weight: bold;
            `;
            alertOverlay.innerHTML = `
                <div>
                    <div style="font-size: 72px; margin-bottom: 20px; color: #dc2626;">üö´</div>
                    <div>${message}</div>
                    <div style="font-size: 16px; color: #9ca3af; margin-top: 10px;">Conte√∫do ultra-protegido</div>
                </div>
            `;
            document.body.appendChild(alertOverlay);
            setTimeout(() => alertOverlay.remove(), 3000);
        }

        function closePDFViewer() {
            const overlay = document.getElementById('pdfViewerOverlay');
            if (overlay) overlay.remove();
        }

        // Show/hide loading screen
        function showLoading(message) {
            const loading = document.getElementById('loadingScreen');
            loading.querySelector('p').textContent = message;
            loading.classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingScreen').classList.add('hidden');
        }

        // Show access denied
        function showAccessDenied(message) {
            const accessDenied = document.getElementById('accessDenied');
            document.getElementById('accessDeniedMessage').textContent = message;
            accessDenied.classList.remove('hidden');
        }

        // Read file as text
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        // üõ°Ô∏è SISTEMA DE SEGURAN√áA M√ÅXIMA - IMPEDIR C√ìPIA DE URL
        function implementMaximumSecurity(token) {
            // 1. LIMPAR URL DA BARRA DE ENDERE√áOS
            history.replaceState(null, '', window.location.pathname);
            
            // 2. BLOQUEAR ACESSO √Ä URL ORIGINAL
            Object.defineProperty(window, 'location', {
                get: function() {
                    return {
                        href: window.location.pathname,
                        origin: window.location.origin,
                        pathname: window.location.pathname,
                        search: '',
                        hash: '',
                        toString: function() { return window.location.pathname; }
                    };
                },
                set: function() { return false; }
            });
            
            // 3. INTERCEPTAR TENTATIVAS DE COPIAR URL
            document.addEventListener('copy', function(e) {
                e.clipboardData.setData('text/plain', 'ACESSO NEGADO - Este convite n√£o pode ser compartilhado');
                e.preventDefault();
            });
            
            // 4. BLOQUEAR DEVELOPER TOOLS COMPLETAMENTE
            let devtools = {open: false, orientation: null};
            const threshold = 160;
            
            setInterval(function() {
                if (window.outerHeight - window.innerHeight > threshold || 
                    window.outerWidth - window.innerWidth > threshold) {
                    if (!devtools.open) {
                        devtools.open = true;
                        document.body.innerHTML = `
                            <div style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
                                        background: #000; color: #fff; display: flex; justify-content: center; 
                                        align-items: center; font-size: 24px; z-index: 999999;">
                                <div style="text-align: center;">
                                    <div style="font-size: 72px; margin-bottom: 20px;">üö´</div>
                                    <div>ACESSO BLOQUEADO</div>
                                    <div style="font-size: 16px; margin-top: 10px;">Developer Tools detectado</div>
                                    <div style="font-size: 14px; margin-top: 20px; color: #999;">
                                        Feche as ferramentas de desenvolvedor e recarregue a p√°gina
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    devtools.open = false;
                }
            }, 500);
            
            // 5. DETECTAR MUDAN√áAS DE FOCO (tentativa de copiar URL)
            let focusLost = false;
            window.addEventListener('blur', function() {
                focusLost = true;
                setTimeout(function() {
                    if (focusLost) {
                        // Usu√°rio pode ter copiado URL - invalidar sess√£o
                        localStorage.clear();
                        sessionStorage.clear();
                        document.body.innerHTML = `
                            <div style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
                                        background: #dc2626; color: #fff; display: flex; justify-content: center; 
                                        align-items: center; font-size: 24px; z-index: 999999;">
                                <div style="text-align: center;">
                                    <div style="font-size: 72px; margin-bottom: 20px;">üö´</div>
                                    <div>SESS√ÉO INVALIDADA</div>
                                    <div style="font-size: 16px; margin-top: 10px;">Poss√≠vel tentativa de compartilhamento detectada</div>
                                    <div style="font-size: 14px; margin-top: 20px; color: #fca5a5;">
                                        Acesse novamente atrav√©s do link original
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }, 3000);
            });
            
            window.addEventListener('focus', function() {
                focusLost = false;
            });
            
            // 6. BLOQUEAR SELE√á√ÉO DE TEXTO COMPLETAMENTE
            document.onselectstart = function() { return false; };
            document.onmousedown = function() { return false; };
            
            // 7. INTERCEPTAR CTRL+L (barra de endere√ßos)
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
                    e.preventDefault();
                    document.body.innerHTML = `
                        <div style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
                                    background: #000; color: #fff; display: flex; justify-content: center; 
                                    align-items: center; font-size: 24px; z-index: 999999;">
                            <div style="text-align: center;">
                                <div style="font-size: 72px; margin-bottom: 20px;">üö´</div>
                                <div>A√á√ÉO BLOQUEADA</div>
                                <div style="font-size: 16px; margin-top: 10px;">Acesso √† barra de endere√ßos negado</div>
                            </div>
                        </div>
                    `;
                    return false;
                }
            });
            
            // 8. CRIAR SESS√ÉO √öNICA POR DISPOSITIVO
            const deviceSession = generateDeviceFingerprint() + '_' + Date.now();
            sessionStorage.setItem('secure_session', deviceSession);
            
            // 9. VERIFICAR INTEGRIDADE DA SESS√ÉO
            setInterval(function() {
                const currentSession = sessionStorage.getItem('secure_session');
                if (!currentSession || currentSession !== deviceSession) {
                    document.body.innerHTML = `
                        <div style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
                                    background: #dc2626; color: #fff; display: flex; justify-content: center; 
                                    align-items: center; font-size: 24px; z-index: 999999;">
                            <div style="text-align: center;">
                                <div style="font-size: 72px; margin-bottom: 20px;">üö´</div>
                                <div>SESS√ÉO COMPROMETIDA</div>
                                <div style="font-size: 16px; margin-top: 10px;">Acesso negado por motivos de seguran√ßa</div>
                            </div>
                        </div>
                    `;
                }
            }, 2000);
            
            console.log('üõ°Ô∏è SEGURAN√áA M√ÅXIMA ATIVADA - URL imposs√≠vel de copiar');
        }

        // Protection functions (same as before)
        function applyProtectionStyles() {
            const style = document.createElement('style');
            style.textContent = `
                body {
                    -webkit-user-select: none !important;
                    -moz-user-select: none !important;
                    -ms-user-select: none !important;
                    user-select: none !important;
                    -webkit-touch-callout: none !important;
                    -webkit-tap-highlight-color: transparent !important;
                }
                * {
                    -webkit-user-select: none !important;
                    -moz-user-select: none !important;
                    -ms-user-select: none !important;
                    user-select: none !important;
                    -webkit-touch-callout: none !important;
                    -webkit-tap-highlight-color: transparent !important;
                }
            `;
            document.head.appendChild(style);
        }

        function initializeProtection() {
            applyProtectionStyles();
            
            document.addEventListener('keydown', function(e) {
                // Only prevent critical actions - no alerts
                if (e.key === 'PrintScreen' || 
                    (e.ctrlKey && ['p', 's'].includes(e.key)) ||
                    e.key === 'F12') {
                    e.preventDefault();
                    return false;
                }
            });
            
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
            
            // Prevent print
            window.addEventListener('beforeprint', function(e) {
                e.preventDefault();
                return false;
            });
        }
        
        function showProtectionOverlay() {
            const overlay = document.getElementById('protectionOverlay');
            overlay.style.display = 'flex';
            setTimeout(() => overlay.style.display = 'none', 3000);
        }
        
        function addWatermark() {
            // Watermark removed to preserve PDF interactivity
            console.log('üõ°Ô∏è Protection active without visual watermark');
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            testSupabaseConnection();
            checkGuestAccess();
            
            // Add Enter key listener for login form
            document.getElementById('adminUsername').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('adminPassword').focus();
                }
            });
            
            document.getElementById('adminPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    authenticateAdmin();
                }
            });
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'975beb22034a77da',t:'MTc1NjMwMTM3NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
